name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode
        run: |
          # Pick the latest Xcode 16.x available on the runner
          XCODE_PATH=$(ls -d /Applications/Xcode_16*.app 2>/dev/null | sort -V | tail -1)
          if [ -z "$XCODE_PATH" ]; then
            XCODE_PATH="/Applications/Xcode.app"
          fi
          echo "Using $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"

      - name: Ensure iOS Simulator Runtime
        run: |
          # Check if any iOS simulator devices exist; if not, download the runtime
          if ! xcrun simctl list devices available | grep -q "iPhone"; then
            echo "No iOS simulators found â€” downloading runtime..."
            xcodebuild -downloadPlatform iOS
          else
            echo "iOS simulators available"
          fi

      - name: Pick Simulator
        id: sim
        run: |
          # Find the first available iPhone simulator
          DEVICE=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data.get('devices', {}).items():
              if 'iOS' not in runtime:
                  continue
              for d in devices:
                  if 'iPhone' in d['name'] and d['isAvailable']:
                      print(d['name'])
                      sys.exit(0)
          print('iPhone 16')
          ")
          echo "device=$DEVICE" >> "$GITHUB_OUTPUT"
          echo "Using simulator: $DEVICE"

      - name: Generate Info.plist
        run: |
          cat > ScrollDown/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>SPORTS_DATA_API_KEY</key>
            <string>CI_PLACEHOLDER</string>
            <key>NSAppTransportSecurity</key>
            <dict>
              <key>NSAllowsLocalNetworking</key>
              <true/>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Build
        run: |
          xcodebuild build-for-testing \
            -scheme ScrollDown \
            -destination 'platform=iOS Simulator,name=${{ steps.sim.outputs.device }}' \
            -quiet

      - name: Test
        run: |
          xcodebuild test-without-building \
            -scheme ScrollDown \
            -destination 'platform=iOS Simulator,name=${{ steps.sim.outputs.device }}' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult

      - name: Coverage Summary
        if: always()
        run: |
          xcrun xccov view --report TestResults.xcresult | head -60
